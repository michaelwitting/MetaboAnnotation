<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Matching MS Spectra against a reference — CompareSpectraParam • MetaboAnnotation</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Matching MS Spectra against a reference — CompareSpectraParam"><meta property="og:description" content="matchSpectra with both query and target being a Spectra object
matches each spectra in query against all spectra in target and reports
matches with a similarity that passes the THRESHFUN condition. The
parameters for the matching can be specified with one of the param objects
listed below:
CompareSpectraParam: the generic parameter object allowing to set all
settings for the compareSpectra() call that is used to perform the
similarity calculation. This includes MAPFUN and FUN defining the
peak-mapping and similarity calculation functions and ppm and tolerance
to define an acceptable difference between m/z values of the compared
peaks. Additional parameters to the compareSpectra call
can be passed along with .... See the help of Spectra() for more
information on these parameters. Parameters requirePrecursor (default
TRUE) and requirePrecursorPeak (default FALSE) allow to pre-filter
the target spectra prior to the actual similarity calculation for each
individual query spectrum. Target spectra can also be pre-filtered based on
retention time if parameter toleranceRt is set to a value different than
the default toleranceRt = Inf. Only target spectra with a retention time
within the query's retention time +/- (toleranceRt + percentRt% of the
query's retention time) are considered. Note that while for ppm and
tolerance only a single value is accepted, toleranceRt and percentRt
can be also of length equal to the number of query spectra hence allowing
to define different rt boundaries for each query spectrum.
While these pre-filters can considerably improve performance, it should be
noted that no matches will be found between query and target spectra with
missing values in the considered variable (precursor m/z or retention
time). For target spectra without retention times (such as for Spectra
from a public reference database such as MassBank) the default
toleranceRt = Inf should thus be used.
Finally, parameter THRESHFUN allows to define a function to be applied to
the similarity scores to define which matches to report. See below for more
details.
MatchForwardReverseParam: performs spectra matching as with
CompareSpectraParam but reports, similar to MS-DIAL, also the reverse
similarity score and the presence ratio. In detail, the matching of query
spectra to target spectra is performed by considering all peaks from the
query and all peaks from the target (reference) spectrum (i.e. forward
matching using an outer join-based peak matching strategy). For matching
spectra also the reverse similarity is calculated considering only peaks
present in the target (reference) spectrum (i.e. using a right join-based
peak matching). This is reported as spectra variable &quot;reverse_score&quot;.
In addition, the ratio between the number of matched peaks and the total
number of peaks in the target (reference) spectra is reported as the
presence ratio (spectra variable &quot;presence_ratio&quot;) and the total
number of matched peaks as &quot;matched_peaks_count&quot;. See examples below
for details. Parameter THRESHFUN_REVERSE allows to define an additional
threshold function to filter matches. If THRESHFUN_REVERSE is defined
only matches with a spectra similarity fulfilling both THRESHFUN and
THRESHFUN_REVERSE are returned. With the default
THRESHFUN_REVERSE = NULL all matches passing THRESHFUN are reported.

"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MetaboAnnotation</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.99.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../articles/MetaboAnnotation.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/RforMassSpectrometry/MetaboAnnotation/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Matching MS Spectra against a reference</h1>
    <small class="dont-index">Source: <a href="https://github.com/RforMassSpectrometry/MetaboAnnotation/blob/HEAD/R/matchSpectra.R" class="external-link"><code>R/matchSpectra.R</code></a></small>
    <div class="hidden name"><code>CompareSpectraParam.Rd</code></div>
    </div>

    <div class="ref-description">
    <p><code>matchSpectra</code> with both <code>query</code> and <code>target</code> being a Spectra object
matches each spectra in <code>query</code> against all spectra in <code>target</code> and reports
matches with a similarity that passes the <code>THRESHFUN</code> condition. The
parameters for the matching can be specified with one of the <code>param</code> objects
listed below:</p><ul><li><p><code>CompareSpectraParam</code>: the <em>generic</em> parameter object allowing to set all
settings for the <code>compareSpectra()</code> call that is used to perform the
similarity calculation. This includes <code>MAPFUN</code> and <code>FUN</code> defining the
peak-mapping and similarity calculation functions and <code>ppm</code> and <code>tolerance</code>
to define an acceptable difference between m/z values of the compared
peaks. Additional parameters to the <code>compareSpectra</code> call
can be passed along with <code>...</code>. See the help of <code>Spectra()</code> for more
information on these parameters. Parameters <code>requirePrecursor</code> (default
<code>TRUE</code>) and <code>requirePrecursorPeak</code> (default <code>FALSE</code>) allow to pre-filter
the target spectra prior to the actual similarity calculation for each
individual query spectrum. Target spectra can also be pre-filtered based on
retention time if parameter <code>toleranceRt</code> is set to a value different than
the default <code>toleranceRt = Inf</code>. Only target spectra with a retention time
within the query's retention time +/- (<code>toleranceRt</code> + <code>percentRt</code>% of the
query's retention time) are considered. Note that while for <code>ppm</code> and
<code>tolerance</code> only a single value is accepted, <code>toleranceRt</code> and <code>percentRt</code>
can be also of length equal to the number of query spectra hence allowing
to define different rt boundaries for each query spectrum.
While these pre-filters can considerably improve performance, it should be
noted that no matches will be found between query and target spectra with
missing values in the considered variable (precursor m/z or retention
time). For target spectra without retention times (such as for <code>Spectra</code>
from a public reference database such as MassBank) the default
<code>toleranceRt = Inf</code> should thus be used.
Finally, parameter <code>THRESHFUN</code> allows to define a function to be applied to
the similarity scores to define which matches to report. See below for more
details.</p></li>
<li><p><code>MatchForwardReverseParam</code>: performs spectra matching as with
<code>CompareSpectraParam</code> but reports, similar to MS-DIAL, also the <em>reverse</em>
similarity score and the <em>presence ratio</em>. In detail, the matching of query
spectra to target spectra is performed by considering all peaks from the
query and all peaks from the target (reference) spectrum (i.e. <em>forward</em>
matching using an <em>outer join</em>-based peak matching strategy). For matching
spectra also the <em>reverse</em> similarity is calculated considering only peaks
present in the target (reference) spectrum (i.e. using a <em>right join</em>-based
peak matching). This is reported as spectra variable <code>"reverse_score"</code>.
In addition, the ratio between the number of matched peaks and the total
number of peaks in the target (reference) spectra is reported as the
<em>presence ratio</em> (spectra variable <code>"presence_ratio"</code>) and the total
number of matched peaks as <code>"matched_peaks_count"</code>. See examples below
for details. Parameter <code>THRESHFUN_REVERSE</code> allows to define an additional
<em>threshold function</em> to filter matches. If <code>THRESHFUN_REVERSE</code> is defined
only matches with a spectra similarity fulfilling both <code>THRESHFUN</code> <strong>and</strong>
<code>THRESHFUN_REVERSE</code> are returned. With the default
<code>THRESHFUN_REVERSE = NULL</code> all matches passing <code>THRESHFUN</code> are reported.</p></li>
</ul></div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="fu">CompareSpectraParam</span><span class="op">(</span>
  MAPFUN <span class="op">=</span> <span class="va">joinPeaks</span>,
  tolerance <span class="op">=</span> <span class="fl">0</span>,
  ppm <span class="op">=</span> <span class="fl">5</span>,
  FUN <span class="op">=</span> <span class="fu">MsCoreUtils</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/MsCoreUtils/man/distance.html" class="external-link">ndotproduct</a></span>,
  requirePrecursor <span class="op">=</span> <span class="cn">TRUE</span>,
  requirePrecursorPeak <span class="op">=</span> <span class="cn">FALSE</span>,
  THRESHFUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&gt;=</span> <span class="fl">0.7</span><span class="op">)</span>,
  toleranceRt <span class="op">=</span> <span class="cn">Inf</span>,
  percentRt <span class="op">=</span> <span class="fl">0</span>,
  <span class="va">...</span>
<span class="op">)</span>

<span class="fu">MatchForwardReverseParam</span><span class="op">(</span>
  MAPFUN <span class="op">=</span> <span class="va">joinPeaks</span>,
  tolerance <span class="op">=</span> <span class="fl">0</span>,
  ppm <span class="op">=</span> <span class="fl">5</span>,
  FUN <span class="op">=</span> <span class="fu">MsCoreUtils</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/MsCoreUtils/man/distance.html" class="external-link">ndotproduct</a></span>,
  requirePrecursor <span class="op">=</span> <span class="cn">TRUE</span>,
  requirePrecursorPeak <span class="op">=</span> <span class="cn">FALSE</span>,
  THRESHFUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&gt;=</span> <span class="fl">0.7</span><span class="op">)</span>,
  THRESHFUN_REVERSE <span class="op">=</span> <span class="cn">NULL</span>,
  toleranceRt <span class="op">=</span> <span class="cn">Inf</span>,
  percentRt <span class="op">=</span> <span class="fl">0</span>,
  <span class="va">...</span>
<span class="op">)</span>

<span class="co"># S4 method for Spectra,Spectra,CompareSpectraParam</span>
<span class="fu"><a href="matchSpectra.html">matchSpectra</a></span><span class="op">(</span><span class="va">query</span>, <span class="va">target</span>, <span class="va">param</span>, BPPARAM <span class="op">=</span> <span class="fu">BiocParallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/SerialParam-class.html" class="external-link">SerialParam</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="co"># S4 method for Spectra,Spectra,MatchForwardReverseParam</span>
<span class="fu"><a href="matchSpectra.html">matchSpectra</a></span><span class="op">(</span><span class="va">query</span>, <span class="va">target</span>, <span class="va">param</span>, BPPARAM <span class="op">=</span> <span class="fu">BiocParallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/SerialParam-class.html" class="external-link">SerialParam</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>MAPFUN</dt>
<dd><p><code>function</code> used to map peaks between the compared spectra.
Defaults for <code>CompareSpectraParam</code> to <code><a href="https://rdrr.io/pkg/Spectra/man/joinPeaks.html" class="external-link">joinPeaks()</a></code>. See
<code><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">compareSpectra()</a></code> for details.</p></dd>
<dt>tolerance</dt>
<dd><p><code>numeric(1)</code> for an absolute maximal accepted difference
between m/z values. This will be used in <code>compareSpectra</code> as well as for
eventual precursor m/z matching.</p></dd>
<dt>ppm</dt>
<dd><p><code>numeric(1)</code> for a relative, m/z-dependent, maximal accepted
difference between m/z values. This will be used in <code>compareSpectra</code> as
well as for eventual precursor m/z matching.</p></dd>
<dt>FUN</dt>
<dd><p><code>function</code> used to calculate similarity between spectra. Defaults
for <code>CompareSpectraParam</code> to <code><a href="https://rdrr.io/pkg/MsCoreUtils/man/distance.html" class="external-link">MsCoreUtils::ndotproduct()</a></code>. See
<code><a href="https://rdrr.io/pkg/MsCoreUtils/man/distance.html" class="external-link">MsCoreUtils::ndotproduct()</a></code> for details.</p></dd>
<dt>requirePrecursor</dt>
<dd><p><code>logical(1)</code> whether only target spectra are
considered in the similarity calculation with a precursor m/z that matches
the precursor m/z of the query spectrum (considering also <code>ppm</code> and
<code>tolerance</code>). With <code>requirePrecursor = TRUE</code> (the default) the function
will complete much faster, but will not find any hits for target (or query
spectra) with missing precursor m/z. It is suggested to check first the
availability of the precursor m/z in <code>target</code> and <code>query</code>.</p></dd>
<dt>requirePrecursorPeak</dt>
<dd><p><code>logical(1)</code> whether only target spectra will be
considered in the spectra similarity calculation that have a peak with an
m/z matching the precursor m/z of the query spectrum. Defaults to
<code>requirePrecursorPeak = FALSE</code>. It is suggested to check first the
availability of the precursor m/z in <code>query</code>, as no match will be reported
for query spectra with missing precursor m/z.</p></dd>
<dt>THRESHFUN</dt>
<dd><p><code>function</code> applied to the similarity score to define which
target spectra are considered <em>matching</em>. Defaults to
<code>THRESHFUN = function(x) which(x &gt;= 0.7)</code> hence selects
all target spectra matching a query spectrum with a similarity higher or
equal than <code>0.7</code>. Any function that takes a numeric vector with similarity
scores from the comparison of a query spectrum with all target spectra (as
returned by <code><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">compareSpectra()</a></code>) as input and returns a
<code>logical</code> vector (same dimensions as the similarity scores) or an integer
with the matches is supported.</p></dd>
<dt>toleranceRt</dt>
<dd><p><code>numeric</code> of length 1 or equal to the number of query
spectra defining the maximal accepted (absolute) difference in retention
time between query and target spectra. By default
(with <code>toleranceRt = Inf</code>) the retention time-based filter is not
considered. See help of <code>CompareSpectraParam</code> above for more
information.</p></dd>
<dt>percentRt</dt>
<dd><p><code>numeric</code> of length 1 or equal to the number of query
spectra defining the maximal accepted relative difference in retention
time between query and target spectra expressed in percentage of the query
rt. For <code>percentRt = 10</code>, similarities are defined between the query
spectrum and all target spectra with a retention time within query rt
+/- 10% of the query. By default (with <code>toleranceRt = Inf</code>) the retention
time-based filter is not considered. Thus, to consider the <code>percentRt</code>
parameter, <code>toleranceRt</code> should be set to a value different than that.
See help of <code>CompareSpectraParam</code> above for more information.</p></dd>
<dt>...</dt>
<dd><p>for <code>CompareSpectraParam</code>: additional parameters passed along
to the <code><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">compareSpectra()</a></code> call.</p></dd>
<dt>THRESHFUN_REVERSE</dt>
<dd><p>for <code>MatchForwardReverseParam</code>: optional additional
<em>thresholding function</em> to filter the results on the reverse score. If
specified the same format than <code>THRESHFUN</code> is expected.</p></dd>
<dt>query</dt>
<dd><p>for <code>matchSpectra</code>: <a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a> object with the query spectra.</p></dd>
<dt>target</dt>
<dd><p>for <code>matchSpectra</code>: <a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a> object with the target
(reference) spectra to compare <code>query</code> against.</p></dd>
<dt>param</dt>
<dd><p>for <code>matchSpectra</code>: parameter object (such as
<code>CompareSpectraParam</code>) defining the settings for the matching.</p></dd>
<dt>BPPARAM</dt>
<dd><p>for <code>matchSpectra</code>: parallel processing setup (see the
<code>BiocParallel</code> package for more information). Parallel processing is
disabled by default.</p></dd>
</dl></div>
    <div id="value">
    <h2>Value</h2>
    <p><code>matchSpectra</code> returns a <code><a href="MatchedSpectra.html">MatchedSpectra()</a></code> object. Constructor
functions return an instance of the class.</p>
    </div>
    <div id="author">
    <h2>Author</h2>
    <p>Johannes Rainer, Michael Witting</p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"></span>
<span class="r-in"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/Spectra" class="external-link">Spectra</a></span><span class="op">)</span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Loading required package: S4Vectors</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Loading required package: stats4</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Loading required package: BiocGenerics</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Attaching package: ‘BiocGenerics’</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> The following objects are masked from ‘package:stats’:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     IQR, mad, sd, var, xtabs</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> The following objects are masked from ‘package:base’:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     Filter, Find, Map, Position, Reduce, anyDuplicated, append,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     as.data.frame, basename, cbind, colnames, dirname, do.call,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     duplicated, eval, evalq, get, grep, grepl, intersect, is.unsorted,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     lapply, mapply, match, mget, order, paste, pmax, pmax.int, pmin,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     pmin.int, rank, rbind, rownames, sapply, setdiff, sort, table,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     tapply, union, unique, unsplit, which.max, which.min</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Attaching package: ‘S4Vectors’</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> The following objects are masked from ‘package:base’:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     I, expand.grid, unname</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Loading required package: BiocParallel</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Loading required package: ProtGenerics</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Attaching package: ‘ProtGenerics’</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> The following object is masked from ‘package:MetaboAnnotation’:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     addProcessing</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> The following object is masked from ‘package:stats’:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     smooth</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Attaching package: ‘Spectra’</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> The following object is masked from ‘package:ProtGenerics’:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     addProcessing</span>
<span class="r-in"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">msdata</span><span class="op">)</span></span>
<span class="r-in"><span class="va">fl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"TripleTOF-SWATH"</span>, <span class="st">"PestMix1_DDA.mzML"</span>, package <span class="op">=</span> <span class="st">"msdata"</span><span class="op">)</span></span>
<span class="r-in"><span class="va">pest_ms2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterMsLevel</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">fl</span><span class="op">)</span>, <span class="fl">2L</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co">## subset to selected spectra.</span></span>
<span class="r-in"><span class="va">pest_ms2</span> <span class="op">&lt;-</span> <span class="va">pest_ms2</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">808</span>, <span class="fl">809</span>, <span class="fl">945</span><span class="op">:</span><span class="fl">955</span><span class="op">)</span><span class="op">]</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co">## Load a small example MassBank data set</span></span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"minimb.RData"</span>, package <span class="op">=</span> <span class="st">"MetaboAnnotation"</span><span class="op">)</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co">## Match spectra with the default similarity score (normalized dot product)</span></span>
<span class="r-in"><span class="va">csp</span> <span class="op">&lt;-</span> <span class="fu">CompareSpectraParam</span><span class="op">(</span>requirePrecursor <span class="op">=</span> <span class="cn">TRUE</span>, ppm <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span class="r-in"><span class="va">mtches</span> <span class="op">&lt;-</span> <span class="fu"><a href="matchSpectra.html">matchSpectra</a></span><span class="op">(</span><span class="va">pest_ms2</span>, <span class="va">minimb</span>, <span class="va">csp</span><span class="op">)</span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-in"></span>
<span class="r-in"><span class="va">mtches</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Object of class MatchedSpectra </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Total number of matches: 16 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Number of query objects: 13 (5 matched)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Number of target objects: 100 (11 matched)</span>
<span class="r-in"></span>
<span class="r-in"><span class="co">## Are there any matching spectra for the first query spectrum?</span></span>
<span class="r-in"><span class="va">mtches</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Object of class MatchedSpectra </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Total number of matches: 0 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Number of query objects: 1 (0 matched)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Number of target objects: 100 (0 matched)</span>
<span class="r-in"><span class="co">## No</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co">## And for the second query spectrum?</span></span>
<span class="r-in"><span class="va">mtches</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Object of class MatchedSpectra </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Total number of matches: 4 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Number of query objects: 1 (1 matched)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Number of target objects: 100 (4 matched)</span>
<span class="r-in"><span class="co">## The second query spectrum matches 4 target spectra. The scores for these</span></span>
<span class="r-in"><span class="co">## matches are:</span></span>
<span class="r-in"><span class="va">mtches</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">$</span><span class="va">score</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 0.7869556 0.8855473 0.7234894 0.7219942</span>
<span class="r-in"></span>
<span class="r-in"><span class="co">## To access the score for the full data set</span></span>
<span class="r-in"><span class="va">mtches</span><span class="op">$</span><span class="va">score</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [1]        NA 0.7869556 0.8855473 0.7234894 0.7219942        NA 0.7769746</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [8] 0.7577286        NA 0.7433718 0.7019807 0.7081274        NA 0.7320465</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [15] 0.8106258 0.7290458 0.8168876 0.7247800 0.7412586 0.7198787        NA</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [22]        NA        NA        NA</span>
<span class="r-in"></span>
<span class="r-in"><span class="co">## Below we use a THRESHFUN that returns for each query spectrum the (first)</span></span>
<span class="r-in"><span class="co">## best matching target spectrum.</span></span>
<span class="r-in"><span class="va">csp</span> <span class="op">&lt;-</span> <span class="fu">CompareSpectraParam</span><span class="op">(</span>requirePrecursor <span class="op">=</span> <span class="cn">FALSE</span>, ppm <span class="op">=</span> <span class="fl">10</span>,</span>
<span class="r-in">    THRESHFUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span class="r-in"><span class="va">mtches</span> <span class="op">&lt;-</span> <span class="fu"><a href="matchSpectra.html">matchSpectra</a></span><span class="op">(</span><span class="va">pest_ms2</span>, <span class="va">minimb</span>, <span class="va">csp</span><span class="op">)</span></span>
<span class="r-in"><span class="va">mtches</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Object of class MatchedSpectra </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Total number of matches: 13 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Number of query objects: 13 (13 matched)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Number of target objects: 100 (10 matched)</span>
<span class="r-in"></span>
<span class="r-in"><span class="co">## Each of the query spectra is matched to one target spectrum</span></span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mtches</span><span class="op">)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 13</span>
<span class="r-in"><span class="fu"><a href="Matched.html">matches</a></span><span class="op">(</span><span class="va">mtches</span><span class="op">)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    query_idx target_idx        score</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1          1          1 0.000000e+00</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2          2         73 8.855473e-01</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3          3          2 6.313687e-01</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4          4         44 7.769746e-01</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5          5         74 1.772117e-05</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6          6          2 7.433718e-01</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 7          7          5 1.906998e-03</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 8          8         53 8.168876e-01</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 9          9         44 7.412586e-01</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 10        10         86 4.085289e-04</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 11        11         53 4.323403e-01</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 12        12         47 3.469648e-03</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 13        13         71 7.612480e-06</span>
<span class="r-in"></span>
<span class="r-in"><span class="co">## Match spectra considering also measured retention times. This requires</span></span>
<span class="r-in"><span class="co">## that both query and target spectra have non-missing retention times.</span></span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">rtime</a></span><span class="op">(</span><span class="va">pest_ms2</span><span class="op">)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [1] 361.651 361.741 377.609 377.699 378.120 378.539 378.779 378.869 378.959</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [10] 379.379 380.059 380.609 381.029</span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">rtime</a></span><span class="op">(</span><span class="va">minimb</span><span class="op">)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [1] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [26] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [51] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [76] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span>
<span class="r-in"></span>
<span class="r-in"><span class="co">## Target spectra don't have retention times. Below we artificially set</span></span>
<span class="r-in"><span class="co">## retention times to show how an additional retention time filter would</span></span>
<span class="r-in"><span class="co">## work.</span></span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">rtime</a></span><span class="op">(</span><span class="va">minimb</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">361</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">minimb</span><span class="op">)</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co">## Matching spectra requiring a matching precursor m/z and the difference</span></span>
<span class="r-in"><span class="co">## of retention times between query and target spectra to be &lt;= 2 seconds.</span></span>
<span class="r-in"><span class="va">csp</span> <span class="op">&lt;-</span> <span class="fu">CompareSpectraParam</span><span class="op">(</span>requirePrecursor <span class="op">=</span> <span class="cn">TRUE</span>, ppm <span class="op">=</span> <span class="fl">10</span>,</span>
<span class="r-in">    toleranceRt <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span class="r-in"><span class="va">mtches</span> <span class="op">&lt;-</span> <span class="fu"><a href="matchSpectra.html">matchSpectra</a></span><span class="op">(</span><span class="va">pest_ms2</span>, <span class="va">minimb</span>, <span class="va">csp</span><span class="op">)</span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>'filterPrecursorMz' is deprecated. Please use 'filterPrecursorMzRange' instead.</span>
<span class="r-in"><span class="va">mtches</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Object of class MatchedSpectra </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Total number of matches: 4 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Number of query objects: 13 (1 matched)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Number of target objects: 100 (4 matched)</span>
<span class="r-in"><span class="fu"><a href="Matched.html">matches</a></span><span class="op">(</span><span class="va">mtches</span><span class="op">)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   query_idx target_idx     score</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1         2         70 0.7869556</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2         2         73 0.8855473</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3         2         75 0.7234894</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4         2         76 0.7219942</span>
<span class="r-in"></span>
<span class="r-in"><span class="co">## See the package vignette for details, descriptions and more examples.</span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Michael Witting, Johannes Rainer, Andrea Vicini.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.9000.</p>
</div>

      </footer></div>

  


  

  </body></html>

